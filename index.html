<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Light Web Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root {
    --bg:#0f1115; --bg2:#0c1118; --panel:#151922; --panel2:#0f141c;
    --accent:#3b82f6; --text:#e5e7eb; --muted:#94a3b8; --border:#232a36;
  }
  [data-theme="light"] {
    --bg:#f6f7fb; --bg2:#ffffff; --panel:#ffffff; --panel2:#f6f8fc;
    --accent:#2563eb; --text:#0f172a; --muted:#475569; --border:#e2e8f0;
  }
  * { box-sizing:border-box; }
  html, body { height:100%; margin:0; }
  body { background:var(--bg); color:var(--text); font:14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; }

  .topbar {
    display:flex; align-items:center; gap:10px; padding:10px 12px;
    border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, var(--panel2), var(--bg));
  }
  .brand { font-weight:700; }
  .toolbar { margin-left:auto; display:flex; gap:8px; flex-wrap:wrap; }
  button, .inputlike {
    background:var(--panel); color:var(--text); border:1px solid var(--border);
    padding:7px 10px; border-radius:8px; cursor:pointer; transition: background .15s, border-color .15s;
  }
  button:hover { border-color:#2c3544; background:rgba(59,130,246,.08); }
  .inputlike { display:inline-flex; align-items:center; gap:6px; }
  #projName { outline:none; padding:0 4px; border-radius:4px; }

  .layout { position:absolute; top:52px; bottom:0; left:0; right:0; display:flex; min-height:0; overflow:hidden; }

  .sidebar {
    width:220px; min-width:160px; max-width:420px;
    display:flex; flex-direction:column;
    background:var(--panel2); border-right:1px solid var(--border);
    transition: width .15s ease;
  }
  .files { flex:1; overflow:auto; padding:6px; }
  .file { padding:6px 8px; border-radius:6px; cursor:pointer; display:flex; justify-content:space-between; gap:8px; }
  .file:hover { background:rgba(59,130,246,.06); }
  .file.active { background:rgba(59,130,246,.15); border:1px solid rgba(59,130,246,.35); }
  .file .name { overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
  .file .ext { color:var(--muted); font-size:12px; }
  /* VS Code-like filename colors */
  .file[data-ext="html"] .name { color:#e34c26; }
  .file[data-ext="css"] .name { color:#563d7c; }
  .file[data-ext="js"] .name { color:#f1e05a; }
  .file[data-ext="ts"] .name { color:#3178c6; }
  .file[data-ext="json"] .name { color:#cbcb41; }
  .file[data-ext="md"] .name { color:#083fa1; }
  .file[data-ext="py"] .name { color:#3572A5; }
  .file[data-ext="c"], .file[data-ext="h"] .name { color:#555; }
  .file[data-ext="cpp"], .file[data-ext="cxx"], .file[data-ext="hpp"] .name { color:#f34b7d; }

  .splitter-v { width:6px; cursor:col-resize; background:var(--bg2); border-left:1px solid var(--border); border-right:1px solid var(--border); }

  .center { flex:1; display:flex; min-width:0; }
  .editor-pane, .right-pane { display:flex; flex-direction:column; min-width:0; background:var(--panel2); }
  .editor-pane { flex:1; border-right:1px solid var(--border); }
  .right-pane { width:50%; min-width:280px; }

  .section-header {
    display:flex; align-items:center; justify-content:space-between; padding:8px 10px;
    border-bottom:1px solid var(--border); background:var(--panel);
  }
  .title { font-weight:600; color:var(--muted); }

  #editor { width:100%; height:100%; }
  #preview { flex:1; width:100%; border:0; background:var(--bg); }

  /* Mobile */
  @media (max-width:900px) {
    .layout { flex-direction:column; }
    .sidebar { position:fixed; top:52px; bottom:0; left:0; z-index:20; width:80%; max-width:360px; transform:translateX(-100%); box-shadow:0 10px 30px rgba(0,0,0,.3); }
    .sidebar.show { transform:translateX(0); }
    .splitter-v { display:none; }
    .center { flex-direction:column; }
    .editor-pane { height:50vh; border-bottom:1px solid var(--border); }
    .right-pane { height:50vh; width:100%; }
  }
</style>
</head>
<body data-theme="dark">
  <div class="topbar">
    <button id="sidebarToggle" title="Toggle Files">üìÅ</button>
    <div class="brand">Light Web Studio</div>
    <div class="inputlike">Project: <span id="projName" contenteditable="true">My Project</span></div>
    <div class="toolbar">
      <button id="addFile">Ôºã File</button>
      <button id="runBtn">‚ñ∂ Run</button>
      <button id="themeToggle">üåû/üåô</button>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <div class="section-header"><div class="title">Files</div></div>
      <div class="files" id="fileList"></div>
    </aside>

    <div class="splitter-v" id="splitLeft"></div>

    <div class="center">
      <section class="editor-pane">
        <div class="section-header"><div class="title" id="activeFileTitle">Editor</div></div>
        <div id="editor"></div>
      </section>

      <div class="splitter-v" id="splitRight"></div>

      <section class="right-pane">
        <div class="section-header"><div class="title">Preview</div></div>
        <iframe id="preview" sandbox="allow-scripts allow-same-origin"></iframe>
      </section>
    </div>
  </div>

  <!-- Monaco Editor -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.43.0/min/vs/loader.min.js"></script>
  <script>
    // Utilities
    const byId = id => document.getElementById(id);
    const extOf = n => (n.split('.').pop()||'').toLowerCase();
    const langOfExt = e => ({
      html:'html', htm:'html', css:'css', scss:'scss', less:'less',
      js:'javascript', ts:'typescript', json:'json', md:'markdown', py:'python',
      xml:'xml', svg:'xml', yml:'yaml', yaml:'yaml', txt:'plaintext'
    }[e] || 'plaintext');

    // Project state (autosave)
    const LS_KEY = 'light_ws_project_v1';
    function defaultProject(){
      return {
        name: 'My Project',
        files: {
          'index.html': `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Light Web Studio</title>
</head>
<body>
  <h1>Hello üëã</h1>
  <p>Edit HTML, CSS, JS ‚Äî then click Run.</p>
  <button id="btn">Click me</button>
</body>
</html>`,
          'styles.css': `body { font-family: system-ui, -apple-system, Segoe UI, Roboto; margin: 24px; }
h1 { color: #3b82f6; }
button { padding: 10px 16px; border-radius: 8px; border: none; background:#1f2937; color: #e5e7eb; }
button:hover { background:#111827; }`,
          'script.js': `console.log("JS running ‚úÖ");
document.getElementById("btn")?.addEventListener("click", ()=> alert("Clicked!"));`
        },
        active: 'index.html',
        theme: 'dark'
      };
    }
    function loadProject(){
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return defaultProject();
        const data = JSON.parse(raw);
        if (!data || !data.files || !Object.keys(data.files).length) return defaultProject();
        return data;
      } catch { return defaultProject(); }
    }
    function saveProject(){ localStorage.setItem(LS_KEY, JSON.stringify(project)); }

    let project = loadProject();

    // Sidebar + file list
    const fileList = byId('fileList');
    function refreshFilesUI(){
      fileList.innerHTML = '';
      Object.keys(project.files).forEach(name=>{
        const ext = extOf(name);
        const el = document.createElement('div');
        el.className = 'file' + (project.active === name ? ' active' : '');
        el.dataset.ext = ext;
        el.innerHTML = `<span class="name">${name}</span><span class="ext">${ext}</span>`;
        el.onclick = () => openFile(name);
        fileList.appendChild(el);
      });
      byId('projName').textContent = project.name;
      byId('activeFileTitle').textContent = project.active;
    }

    byId('addFile').addEventListener('click', ()=>{
      const name = prompt('New file name (e.g., page.html, app.js, styles.css):', 'untitled.txt');
      if (!name) return;
      if (project.files[name]) { alert('File already exists'); return; }
      project.files[name] = '';
      saveProject();
      ensureModel(name);
      openFile(name);
    });

    byId('projName').addEventListener('input', ()=>{
      project.name = byId('projName').textContent.trim() || 'My Project';
      saveProject();
    });

    // Theme toggle
    function applyTheme(th){
      document.body.setAttribute('data-theme', th);
      if (window.monaco && monaco.editor) monaco.editor.setTheme(th === 'dark' ? 'vs-dark' : 'vs-light');
      project.theme = th; saveProject();
    }
    byId('themeToggle').addEventListener('click', ()=>{
      const th = (document.body.getAttribute('data-theme') === 'dark') ? 'light' : 'dark';
      applyTheme(th);
    });
    applyTheme(project.theme || 'dark');

    // Monaco setup
    let editor, models = {};
    function bindModel(model, name){
      model.onDidChangeContent(()=>{
        project.files[name] = model.getValue();
        saveProject();
      });
    }
    function ensureModel(name){
      if (models[name]) return models[name];
      const value = project.files[name] ?? '';
      const lang = langOfExt(extOf(name));
      const uri = monaco.Uri.parse('inmemory:///' + name);
      const model = monaco.editor.createModel(value, lang, uri);
      models[name] = model;
      bindModel(model, name);
      return model;
    }
    function openFile(name){
      project.active = name;
      editor.setModel(ensureModel(name));
      refreshFilesUI();
    }

    // Load Monaco and configure validation
    window.require.config({ paths:{ 'vs':'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.43.0/min/vs' } });
    window.require(['vs/editor/editor.main'], function(){
      // Create models
      Object.keys(project.files).forEach(ensureModel);

      // Editor
      editor = monaco.editor.create(byId('editor'),{
        model: models[project.active],
        theme: project.theme === 'dark' ? 'vs-dark' : 'vs-light',
        automaticLayout: true,
        fontSize: 14,
        minimap: { enabled: true },
        wordWrap: 'on',
        smoothScrolling: true,
        scrollBeyondLastLine: false,
        autoClosingBrackets: 'always',
        autoClosingQuotes: 'always'
      });

      // Auto-closing HTML tags + validation
      monaco.languages.html.htmlDefaults.setOptions({ validate:true, autoClosingTags:true });
      monaco.languages.css.cssDefaults.setOptions({ validate:true });
      monaco.languages.typescript.javascriptDefaults.setDiagnosticsOptions({
        noSemanticValidation:false, noSyntaxValidation:false
      });
      monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({
        noSemanticValidation:false, noSyntaxValidation:false
      });

      // ‚Äú!‚Äù + Enter ‚Üí HTML boilerplate, else normal Enter
      editor.addCommand(monaco.KeyCode.Enter, ()=>{
        const model = editor.getModel();
        const pos = editor.getPosition();
        const line = model.getLineContent(pos.lineNumber);
        if (model.getLanguageId() === 'html' && line.trim() === '!' && pos.column === line.length + 1) {
          const range = new monaco.Range(pos.lineNumber, 1, pos.lineNumber, line.length + 1);
          model.pushEditOperations([], [{
            range, text: `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
</head>
<body>

</body>
</html>`
          }], ()=>null);
        } else {
          editor.trigger('keyboard','type',{ text:'\n' });
        }
      });

      refreshFilesUI();
    });

    // Preview: build iframe from files
    const iframe = byId('preview');
    function run(){
      const files = project.files;
      const htmlEntry = Object.keys(files).find(n => n.toLowerCase().endsWith('.html')) || 'index.html';
      const allCSS = Object.keys(files).filter(n => n.toLowerCase().endsWith('.css')).map(n=>files[n]).join('\n\n');
      const allJS  = Object.keys(files).filter(n => n.toLowerCase().endsWith('.js')).map(n=>files[n]).join('\n;\n');
      const htmlBody = files[htmlEntry] || '';

      const doc = `
<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>${allCSS}</style>
</head>
<body>
${htmlBody}
<script>
try {
${allJS}
} catch (e) { console.error(e); }
<\/script>
</body>
</html>`;
      iframe.srcdoc = doc;
    }
    byId('runBtn').addEventListener('click', run);

    // Sidebar toggle (mobile drawer)
    byId('sidebarToggle').addEventListener('click', ()=>{
      const sb = byId('sidebar');
      if (window.matchMedia('(max-width:900px)').matches) sb.classList.toggle('show');
      else sb.style.width = (sb.style.width && parseInt(sb.style.width) < 40) ? '220px' : '0px';
    });

    // Smooth splitters
    (function initSplitters(){
      const splitLeft = byId('splitLeft');
      const splitRight = byId('splitRight');
      const sidebar = byId('sidebar');
      const rightPane = document.querySelector('.right-pane');

      let dragV = null, frame = null, target = 0;

      const onMoveV = (e, side) => {
        if (side === 'left') {
          target = Math.min(Math.max(e.clientX, 140), window.innerWidth - 300);
          if (!frame) frame = requestAnimationFrame(()=>{ frame=null; sidebar.style.width = target + 'px'; });
        } else {
          const center = document.querySelector('.center');
          const rect = center.getBoundingClientRect();
          const x = Math.min(Math.max(e.clientX - rect.left, 300), rect.width - 220);
          if (!frame) frame = requestAnimationFrame(()=>{ frame=null; rightPane.style.width = (center.clientWidth - x) + 'px'; });
        }
        if (window.editor) editor.layout();
      };

      splitLeft.addEventListener('mousedown', ()=> dragV = 'left');
      splitRight.addEventListener('mousedown', ()=> dragV = 'right');
      window.addEventListener('mousemove', e => { if (dragV) onMoveV(e, dragV); });
      window.addEventListener('mouseup', ()=> dragV = null);
    })();

    // Initial preview
    run();
  </script>
</body>
</html>
